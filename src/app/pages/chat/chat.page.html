<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div *ngIf="contratacion">
        <div class="chat-title">{{ contratacion.plan?.nombre }}</div>
        <div class="chat-subtitle">
          {{ isMiMensaje(mensajes[0] || {} as any) ? contratacion.usuario?.nombre : 'Asesor Comercial' }}
        </div>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
  </div>

  <div *ngIf="!loading" class="messages-container">
    <div *ngIf="contratacion" class="contrato-info">
      <ion-chip color="primary">
        <ion-label>Contratación: {{ contratacion.estado | titlecase }}</ion-label>
      </ion-chip>
    </div>

    <div *ngFor="let mensaje of mensajes" 
         [class]="isMiMensaje(mensaje) ? 'message-item my-message' : 'message-item other-message'">
      <div class="message-bubble">
        <div class="message-header">
          <span class="sender-name">{{ mensaje.emisor?.nombre }}</span>
          <span class="message-time">{{ mensaje.created_at | date:'HH:mm' }}</span>
        </div>
        <div class="message-text">{{ mensaje.mensaje }}</div>
      </div>
    </div>

    <div *ngIf="mensajes.length === 0" class="empty-chat">
      <ion-icon name="chatbubble-outline" size="large"></ion-icon>
      <p>No hay mensajes aún. ¡Inicia la conversación!</p>
    </div>
  </div>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-item lines="none">
      <ion-textarea
        [(ngModel)]="nuevoMensaje"
        placeholder="Escribe un mensaje..."
        rows="1"
        autoGrow="true"
        (keypress)="onKeyPress($event)"
        [disabled]="sending">
      </ion-textarea>
      <ion-button 
        slot="end" 
        (click)="enviarMensaje()"
        [disabled]="!nuevoMensaje.trim() || sending">
        <ion-icon *ngIf="!sending" name="send-outline" slot="icon-only"></ion-icon>
        <ion-spinner *ngIf="sending" name="crescent"></ion-spinner>
      </ion-button>
    </ion-item>
  </ion-toolbar>
</ion-footer>
